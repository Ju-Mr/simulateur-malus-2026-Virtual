<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur - Coût du certificat d'immatriculation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Marianne", -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f6f6f6;
            color: #161616;
            line-height: 1.5;
        }

        .header {
            background: #000091;
            color: white;
            padding: 16px 24px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            margin: 0;
        }

        .header p {
            font-size: 13px;
            opacity: 0.95;
            margin-top: 4px;
        }

        .container {
            max-width: 800px;
            margin: 24px auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }

        .alert-info {
            background: #e3e3fd;
            border-left: 4px solid #000091;
            padding: 12px 16px;
            margin: 16px;
            border-radius: 4px;
            font-size: 13px;
            color: #000091;
        }

        .form-section {
            padding: 24px;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e5e5;
        }

        .step-number {
            background: #000091;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }

        .step-title {
            font-size: 18px;
            font-weight: 700;
            color: #000091;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 700;
            margin-bottom: 8px;
            color: #161616;
            font-size: 14px;
        }

        .label-hint {
            font-weight: 400;
            color: #666;
            font-size: 12px;
            display: block;
            margin-top: 4px;
            line-height: 1.4;
        }

        select, input[type="date"], input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
            background: white;
            transition: border-color 0.2s;
        }

        select:focus, input:focus {
            outline: none;
            border-color: #000091;
        }

        .btn-primary {
            width: 100%;
            padding: 14px 24px;
            background: #000091;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: background 0.2s;
            margin-top: 20px;
        }

        .btn-primary:hover:not(:disabled) {
            background: #1212ff;
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            display: none;
            padding: 24px;
            background: #f6f6f6;
        }

        .results.show {
            display: block;
        }

        .results-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .check-icon {
            background: #18753c;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
        }

        .results-title h2 {
            font-size: 20px;
            font-weight: 700;
            color: #000091;
            margin: 0;
        }

        .result-recap {
            background: white;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            border-left: 4px solid #000091;
        }

        .result-detail {
            background: white;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
            border-left: 4px solid #000091;
        }

        .detail-title {
            font-weight: 700;
            color: #000091;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e5e5e5;
            font-size: 14px;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
        }

        .detail-value {
            font-weight: 600;
            color: #161616;
        }

        .total-box {
            background: #000091;
            color: white;
            padding: 20px;
            border-radius: 4px;
            text-align: center;
        }

        .total-label {
            font-size: 13px;
            opacity: 0.9;
            margin-bottom: 8px;
        }

        .total-value {
            font-size: 32px;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .container {
                margin: 16px;
            }

            .form-section, .results {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Simulateur - Estimer le coût d'un certificat d'immatriculation</h1>
            <p>Carte grise - Barèmes officiels 2026</p>
        </div>
    </div>

    <div class="container">
        <div class="alert-info">
            <strong>ℹ️ Information :</strong> Les résultats sont donnés à titre indicatif selon les barèmes en vigueur.
        </div>

        <div class="form-section">
            <form id="malusForm">
                <!-- ÉTAPE 1: DÉMARCHE -->
                <div class="step-header">
                    <div class="step-number">1</div>
                    <div class="step-title">Votre démarche</div>
                </div>

                <div class="form-group">
                    <label for="demarche">
                        Quelle démarche souhaitez-vous effectuer ?
                        <span class="label-hint">Lorsque le certificat d'immatriculation est demandé pour plusieurs motifs, c'est le motif qui entraîne le coût le plus élevé qui est pris en compte.</span>
                    </label>
                    <select id="demarche" required>
                        <option value="">Sélectionnez votre démarche ou tapez un mot clé</option>
                        <option value="1">Première immatriculation en France d'un véhicule</option>
                        <option value="2">Immatriculation d'un véhicule d'occasion</option>
                        <option value="3">Changement d'adresse</option>
                        <option value="4">Duplicata</option>
                        <option value="5">Achat par le locataire après LLD/LOA/crédit bail</option>
                        <option value="6">Ajout ou retrait d'une personne sur la carte</option>
                        <option value="7">Usurpation du numéro d'immatriculation du véhicule</option>
                        <option value="8">Passage en véhicule de collection</option>
                        <option value="9">Remplacement d'un véhicule détruit lors d'une catastrophe naturelle</option>
                        <option value="10">Héritage (hors veuvage) d'un véhicule</option>
                        <option value="11">Modification du véhicule</option>
                        <option value="12">Correction d'erreur de saisie sur le certificat du fait de l'administration</option>
                        <option value="13">Certificat W garage</option>
                    </select>
                </div>

                <div class="form-group" id="originGroup" style="display: none;">
                    <label>
                        Précisez si le véhicule a été
                    </label>
                    <div style="margin-top: 8px;">
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 4px; margin-bottom: 8px; cursor: pointer; font-weight: 400;">
                            <input type="radio" name="origine" value="neuf" style="margin-right: 8px; width: auto;">
                            Acheté neuf en France ou à l'étranger
                        </label>
                        <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #ddd; border-radius: 4px; cursor: pointer; font-weight: 400;">
                            <input type="radio" name="origine" value="importé" style="margin-right: 8px; width: auto;">
                            Importé en France après avoir été immatriculé dans un autre pays
                        </label>
                    </div>
                </div>

                <!-- ÉTAPE 2: VÉHICULE -->
                <div class="step-header" style="margin-top: 32px;">
                    <div class="step-number">2</div>
                    <div class="step-title">Votre véhicule</div>
                </div>

                <div class="form-group">
                    <label for="typeVehicule">
                        Quel est le type de votre véhicule ?
                    </label>
                    <select id="typeVehicule" required>
                        <option value="">Sélectionnez le genre de votre véhicule</option>
                        <option value="1">Véhicule de tourisme (VT ou M1) ex-Voiture particulière (VP)</option>
                        <option value="2">Camionnette, Utilitaire pour le transport de marchandises jusqu'à 3,5 tonnes (CTTE, N1)</option>
                        <option value="3">Moto jusqu'à 125 cm³ (MTL, L3e, L4e)</option>
                        <option value="4">Moto de plus de 125 cm³ (MTT1, MTT2, L3e, L4e)</option>
                        <option value="5">Cyclomoteur à 2 ou 3 roues (moins de 50 cm³) non carrossé</option>
                        <option value="6">Tricycle à moteur</option>
                        <option value="7">Quad et Quadricycle à moteur (QM, L6e, L7e)</option>
                        <option value="8">Transport en commun de personnes (TCP, M2, M3)</option>
                        <option value="9">Camping-car et autre véhicule Véhicules automoteurs spécialisés (VASP)</option>
                        <option value="10">Camion - PTAC > à 3,5 tonnes et < à 6 tonnes</option>
                        <option value="11">Camion - PTAC > ou = à 6 tonnes et < à 11 tonnes</option>
                        <option value="12">Camion - PTAC > ou = à 11 tonnes</option>
                        <option value="13">Tracteur routier jusqu'à 3,5 tonnes (TRR, N1)</option>
                        <option value="14">Tracteur routier de plus de 3,5 tonnes (N2, N3)</option>
                        <option value="15">Véhicule agricole</option>
                        <option value="16">Caravane, remorque et semi-remorque</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="dateMiseEnCirculation">
                        Quelle est la date de première mise en circulation du véhicule ?
                        <span class="label-hint">L'ancienneté du véhicule se calcule à partir de la date de 1ère mise en circulation</span>
                    </label>
                    <input type="date" id="dateMiseEnCirculation" required max="2026-01-07">
                </div>

                <div class="form-group">
                    <label for="puissance">
                        Quelle est la puissance administrative nationale en CV ?
                        <span class="label-hint">La puissance administrative nationale (puissance fiscale en chevaux vapeur) est mentionnée à la rubrique P.6 de la carte grise</span>
                    </label>
                    <input type="number" id="puissance" min="1" max="50" placeholder="Ex: 7" required>
                </div>

                <div class="form-group">
                    <label for="energie">
                        Quelle est la source d'énergie du véhicule ?
                        <span class="label-hint">Le type de carburant ou la source d'énergie utilisé par le véhicule est mentionné à la rubrique P.3 de la carte grise</span>
                    </label>
                    <select id="energie" required>
                        <option value="">Sélectionnez</option>
                        <option value="EL">Électricité (EL), Hydrogène (H2) ou combinaison des 2 (HE, HH)</option>
                        <option value="ES">Essence (ES)</option>
                        <option value="GO">Gazole (GO), Biogazole B100 (BL)</option>
                        <option value="EH">Essence/électricité - hybride non rechargeable (EH)</option>
                        <option value="EE">Essence/électricité - hybride rechargeable (EE)</option>
                        <option value="GP">GPL (GP)</option>
                        <option value="FE">Superéthanol E85 (FE, FG, FN)</option>
                    </select>
                </div>

                <div class="form-group" id="co2Group">
                    <label for="co2">
                        Quel est le taux d'émission CO2 (V.7) en g/km du véhicule ?
                        <span class="label-hint">Le taux d'émission en CO² est mentionné à la rubrique V.7 de la carte grise</span>
                    </label>
                    <input type="number" id="co2" min="0" max="500" placeholder="Ex: 120">
                </div>

                <div class="form-group" id="poidsGroup">
                    <label for="poids">
                        Quel est le poids du véhicule en kg ?
                        <span class="label-hint">Il s'agit de l'information "Masse du véhicule en service (en kg)" indiquée sur la carte grise à la rubrique G (correspondant à G1 + 75kg)</span>
                    </label>
                    <input type="number" id="poids" min="100" max="5000" placeholder="Ex: 1600">
                </div>

                <!-- ÉTAPE 3: DÉPARTEMENT -->
                <div class="step-header" style="margin-top: 32px;">
                    <div class="step-number">3</div>
                    <div class="step-title">Votre lieu de résidence</div>
                </div>

                <div class="form-group">
                    <label for="departement">
                        Quel est votre département ?
                    </label>
                    <select id="departement" required>
                        <option value="">Sélectionnez votre département ou tapez un mot clé</option>
                        <option value="1,41.90">01 - Ain</option>
                        <option value="2,51.20">02 - Aisne</option>
                        <option value="3,46.15">03 - Allier</option>
                        <option value="4,55.00">04 - Alpes-de-Haute-Provence</option>
                        <option value="5,56.00">05 - Hautes-Alpes</option>
                        <option value="6,55.00">06 - Alpes-Maritimes</option>
                        <option value="7,51.80">07 - Ardèche</option>
                        <option value="8,47.00">08 - Ardennes</option>
                        <option value="9,51.00">09 - Ariège</option>
                        <option value="10,48.60">10 - Aube</option>
                        <option value="17,51.00">17 - Charente-Maritime</option>
                        <option value="40,53.00">40 - Landes</option>
                        <option value="69,53.00">69 - Rhône</option>
                        <option value="75,41.60">75 - Paris</option>
                        <option value="92,60.00">92 - Hauts-de-Seine</option>
                        <option value="93,51.80">93 - Seine-Saint-Denis</option>
                        <option value="94,46.15">94 - Val-de-Marne</option>
                    </select>
                </div>

                <button type="submit" class="btn-primary">Calculer le coût</button>
            </form>
        </div>

        <div class="results" id="results">
            <div class="results-title">
                <div class="check-icon">✓</div>
                <h2>Résultat</h2>
            </div>

            <div class="result-recap" id="recapDemarche"></div>

            <div class="result-detail">
                <div class="detail-title">Détail du calcul</div>
                <div class="detail-row">
                    <span class="detail-label">Taxe régionale (Y1)</span>
                    <span class="detail-value" id="taxeRegionale">0,00 €</span>
                </div>
                <div class="detail-row" id="malusCO2Row">
                    <span class="detail-label">Taxe CO2 (Y3) - Malus écologique</span>
                    <span class="detail-value" id="malusCO2">0,00 €</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Taxe de gestion (Y4)</span>
                    <span class="detail-value">11,00 €</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Redevance d'acheminement (Y5)</span>
                    <span class="detail-value">2,76 €</span>
                </div>
            </div>

            <div class="total-box">
                <div class="total-label">Le coût de ce certificat d'immatriculation sera de</div>
                <div class="total-value" id="totalFinal">0,00 €</div>
            </div>
        </div>
    </div>

    <script>
        // Barèmes officiels 2026
        const BAREMES = {
            malusCO2_2026: {
                108: 50, 109: 75, 110: 100, 111: 125, 112: 150, 113: 170, 114: 190,
                115: 210, 116: 230, 117: 240, 118: 260, 119: 280, 120: 310, 121: 330,
                122: 360, 123: 400, 124: 450, 125: 540, 126: 650, 127: 740, 128: 818,
                129: 898, 130: 983, 131: 1074, 132: 1172, 133: 1276, 134: 1386, 135: 1504,
                136: 1629, 137: 1761, 138: 1901, 139: 2049, 140: 2205, 141: 2370, 142: 2544,
                143: 2727, 144: 2918, 145: 3119, 146: 3329, 147: 3548, 148: 3777, 149: 4017,
                150: 4500, 151: 5000, 152: 5500, 153: 6000, 154: 6500, 155: 7000, 156: 7500,
                157: 8000, 158: 8500, 159: 9000, 160: 9500, 161: 10000, 162: 10500, 163: 11000,
                164: 11500, 165: 12000, 166: 12500, 167: 13000, 168: 13500, 169: 14000, 170: 14500,
                171: 15000, 172: 16000, 173: 17000, 174: 18000, 175: 19000, 176: 20000, 177: 21000,
                178: 22000, 179: 23000, 180: 24000, 181: 25000, 182: 26000, 183: 27000, 184: 28000,
                185: 29000, 186: 30000, 187: 31000, 188: 32000, 189: 33000, 190: 34000, 191: 35000,
                192: 36000, 193: 37000, 194: 38000, 195: 39000, 196: 40000, 197: 45000, 198: 50000,
                199: 55000, 200: 60000
            },
            decotePIVO: [
                { maxMois: 0, taux: 0 }, { maxMois: 3, taux: 3 }, { maxMois: 6, taux: 6 },
                { maxMois: 9, taux: 9 }, { maxMois: 12, taux: 12 }, { maxMois: 18, taux: 16 },
                { maxMois: 24, taux: 20 }, { maxMois: 36, taux: 28 }, { maxMois: 48, taux: 33 },
                { maxMois: 60, taux: 38 }, { maxMois: 72, taux: 43 }, { maxMois: 84, taux: 48 },
                { maxMois: 96, taux: 53 }, { maxMois: 108, taux: 58 }, { maxMois: 120, taux: 64 },
                { maxMois: 132, taux: 70 }, { maxMois: 144, taux: 76 }, { maxMois: 156, taux: 82 },
                { maxMois: 168, taux: 88 }, { maxMois: 180, taux: 94 }, { maxMois: Infinity, taux: 100 }
            ]
        };

        // Gestion affichage conditionnel
        document.getElementById('demarche').addEventListener('change', function() {
            const originGroup = document.getElementById('originGroup');
            if (this.value === '1') {
                originGroup.style.display = 'block';
            } else {
                originGroup.style.display = 'none';
            }
        });

        document.getElementById('energie').addEventListener('change', function() {
            const co2Group = document.getElementById('co2Group');
            const poidsGroup = document.getElementById('poidsGroup');
            if (this.value === 'EL') {
                co2Group.style.display = 'none';
                poidsGroup.style.display = 'none';
            } else {
                co2Group.style.display = 'block';
                poidsGroup.style.display = 'block';
            }
        });

        function calculerMalusCO2(co2) {
            if (co2 < 108) return 0;
            if (co2 >= 200) return 60000;
            if (BAREMES.malusCO2_2026[co2]) return BAREMES.malusCO2_2026[co2];
            for (let seuil in BAREMES.malusCO2_2026) {
                if (co2 <= parseInt(seuil)) return BAREMES.malusCO2_2026[seuil];
            }
            return 60000;
        }

        function calculerMalusPoids(poids, anneeImmat) {
            if (anneeImmat < 2022 || poids < 1500) return 0;
            let malus = 0;
            if (poids >= 1500 && poids < 1700) malus = (poids - 1499) * 10;
            else if (poids >= 1700 && poids < 1800) malus = 200*10 + (poids-1699)*15;
            else if (poids >= 1800 && poids < 1900) malus = 200*10 + 100*15 + (poids-1799)*20;
            else if (poids >= 1900 && poids < 2000) malus = 200*10 + 100*15 + 100*20 + (poids-1899)*25;
            else if (poids >= 2000) malus = 200*10 + 100*15 + 100*20 + 100*25 + (poids-1999)*30;
            return Math.round(malus);
        }

        function calculerDecotePIVO(ageEnMois) {
            for (let palier of BAREMES.decotePIVO) {
                if (ageEnMois <= palier.maxMois) return palier.taux;
            }
            return 100;
        }

        document.getElementById('malusForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const demarche = document.getElementById('demarche').value;
            const typeVehicule = document.getElementById('typeVehicule').value;
            const dateCirculation = document.getElementById('dateMiseEnCirculation').value;
            const puissance = parseInt(document.getElementById('puissance').value);
            const energie = document.getElementById('energie').value;
            const co2 = parseInt(document.getElementById('co2').value) || 0;
            const poids = parseInt(document.getElementById('poids').value) || 0;
            const [deptNum, tauxRegional] = document.getElementById('departement').value.split(',');
            
            // Calcul âge
            const dateVehicule = new Date(dateCirculation);
            const dateActuelle = new Date('2026-01-07');
            const ageEnMois = Math.floor((dateActuelle - dateVehicule) / (1000*60*60*24*30.44));
            const anneeVehicule = dateVehicule.getFullYear();
            
            // Taxe régionale
            const taxeRegionale = puissance * parseFloat(tauxRegional);
            
            // Malus CO2 + Poids avec décote
            let malusCO2 = 0, malusPoids = 0;
            if (energie !== 'EL') {
                const malusCO2Base = calculerMalusCO2(co2);
                const malusPoidsBase = calculerMalusPoids(poids, anneeVehicule);
                const tauxDecote = calculerDecotePIVO(ageEnMois);
                
                malusCO2 = Math.round(malusCO2Base * (1 - tauxDecote/100));
                malusPoids = Math.round(malusPoidsBase * (1 - tauxDecote/100));
                
                // Plafonnement 80000€
                if (malusCO2 + malusPoids > 80000) {
                    malusCO2 = 80000 - malusPoids;
                }
            }
            
            const malusTotal = malusCO2 + malusPoids;
            const taxeGestion = 11.00;
            const redevance = 2.76;
            const total = taxeRegionale + malusTotal + taxeGestion + redevance;
            
            // Affichage
            const demarcheLabels = {
                '1': 'Première immatriculation en France d\'un véhicule',
                '2': 'Immatriculation d\'un véhicule d\'occasion'
            };
            
            document.getElementById('recapDemarche').innerHTML = `<p>Vous souhaitez effectuer une <strong>${demarcheLabels[demarche] || 'démarche'}</strong>.</p>`;
            document.getElementById('taxeRegionale').textContent = taxeRegionale.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('malusCO2').textContent = malusTotal.toFixed(2).replace('.', ',') + ' €';
            document.getElementById('totalFinal').textContent = total.toFixed(2).replace('.', ',') + ' €';
            
            document.getElementById('results').classList.add('show');
            document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        });
    </script>
</body>
</html>
